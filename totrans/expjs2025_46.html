<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>39 WeakSets (WeakSet) ES6 (advanced)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>39 WeakSets (WeakSet) ES6 (advanced)</h1>
<blockquote>原文：<a href="https://exploringjs.com/js/book/ch_weaksets.html">https://exploringjs.com/js/book/ch_weaksets.html</a></blockquote>

        
    
    
    
<p><span id="index-entry-WeakSet"/><span id="index-entry-WeakSet2"/></p>
<nav class="local-toc">
  <ol>
    <li>
      <a href="#sets-vs-weaksets">39.1 How are WeakSets different from Sets?</a>
    </li>
    <li>
      <a href="#marking-objects-via-weaksets">39.2 Use case for WeakSets: marking objects</a>
      <ol>
        <li>
          <a href="#example-marking-objects-as-safe-to-use-with-a-method">39.2.1 Example: Marking objects as safe to use with a method</a>
        </li>
      </ol>
    </li>
    <li>
      <a href="#weakset-api">39.3 WeakSet API</a>
    </li>
  </ol>
</nav>
<h3 id="sets-vs-weaksets"><a class="heading-id-link" href="#sets-vs-weaksets">39.1 How are WeakSets different from Sets?</a></h3>
<p>WeakSets are similar to Sets, with the following differences:</p>
<ul>
  <li>
    <p>They can hold objects without preventing those objects from being garbage-collected.</p>
  </li>
  <li>
    <p>They are black boxes: we only get any data out of a WeakSet if we have both the WeakSet and a value. The only methods that are supported are <code>.add()</code>, <code>.delete()</code>, <code>.has()</code>. See the section on <a href="ch_weakmaps.html#weakmaps-as-black-boxes">WeakMaps as black boxes</a> for an explanation of why WeakSets don’t allow iteration, looping, and clearing.</p>
  </li>
</ul>
<h3 id="marking-objects-via-weaksets"><a class="heading-id-link" href="#marking-objects-via-weaksets">39.2 Use case for WeakSets: marking objects</a></h3>
<p>Given that we can’t iterate over the elements of WeakSets, there are not that many use cases for them.</p>
<p>We can use WeakSets to mark objects – for example:</p>
<pre class="language-js">
<span class="hljs-keyword">const</span> isSaved = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakSet</span>();
{
  <span class="hljs-keyword">const</span> obj = {};
  isSaved.<span class="hljs-title function_">add</span>(obj); <span class="hljs-comment">// (A)</span>
  assert.<span class="hljs-title function_">equal</span>(
    isSaved.<span class="hljs-title function_">has</span>(obj), <span class="hljs-comment">// (B)</span>
    <span class="hljs-literal">true</span>
  );
}
<span class="hljs-comment">// (C)</span>
</pre>
<ul>
  <li>
    In line A, we mark <code>obj</code> as saved.
  </li>
  <li>
    In line B, we check if <code>obj</code> is saved.
  </li>
  <li>
    In line C, <code>obj</code> can be garbage-collected even though it is an element of the data structure <code>isSaved</code>.
  </li>
</ul>
<p>In a way, we created a boolean property for <code>obj</code>, but stored it externally. If <code>isSaved</code> were a property, the previous code would look as follows:</p>
<pre class="language-js">
{
  <span class="hljs-keyword">const</span> obj = {};
  obj.<span class="hljs-property">isSaved</span> = <span class="hljs-literal">true</span>;
  assert.<span class="hljs-title function_">equal</span>(
    obj.<span class="hljs-property">isSaved</span>,
    <span class="hljs-literal">true</span>
  );
}
</pre>
<h4 id="example-marking-objects-as-safe-to-use-with-a-method"><a class="heading-id-link" href="#example-marking-objects-as-safe-to-use-with-a-method">39.2.1 Example: Marking objects as safe to use with a method</a></h4>
<p>The following code demonstrates how a class can ensure that its methods are only applied to instances that were created by it (based on <a href="https://esdiscuss.org/topic/actual-weakset-use-cases#content-1">code by Domenic Denicola</a>):</p>
<pre class="language-js">
<span class="hljs-keyword">const</span> instancesOfSafeClass = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakSet</span>();
<code/>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeClass</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">) {</span>
<span class="hljs-params">    instancesOfSafeClass.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>);</span>
<span class="hljs-params">  }</span>
<code/>
<span class="hljs-params">  <span class="hljs-title function_">method</span>(<span class="hljs-params"/>) {</span>
<span class="hljs-params">    <span class="hljs-keyword">if</span> (!instancesOfSafeClass.<span class="hljs-title function_">has</span>(<span class="hljs-variable language_">this</span>)) {</span>
<span class="hljs-params">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Incompatible object!'</span>);</span>
<span class="hljs-params">    }</span>
<span class="hljs-params">  }</span>
<span class="hljs-params">}</span>
<code/>
<span class="hljs-params"><span class="hljs-keyword">const</span> safeInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeClass</span>();</span>
<span class="hljs-params">safeInstance.<span class="hljs-title function_">method</span>(); <span class="hljs-comment">// works</span></span>
<code/>
<span class="hljs-params">assert.<span class="hljs-title function_">throws</span>(</span>
<span class="hljs-params">  <span class="hljs-function">() =&gt;</span> {</span>
<span class="hljs-params">    <span class="hljs-keyword">const</span> obj = {};</span>
<span class="hljs-params">    <span class="hljs-title class_">SafeClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">method</span>.<span class="hljs-title function_">call</span>(obj); <span class="hljs-comment">// throws an exception</span></span>
<span class="hljs-params">  },</span>
<span class="hljs-params">  <span class="hljs-title class_">TypeError</span></span>
<span class="hljs-params">);</span>
</pre>
<h3 id="weakset-api"><a class="heading-id-link" href="#weakset-api">39.3 WeakSet API</a></h3>
<p>The constructor and the three methods of <code>WeakSet</code> work the same as <a href="ch_sets.html#quickref-sets">their <code>Set</code> equivalents</a>:</p>
<ul>
  <li>
    <code>new WeakSet&lt;T&gt;(values?: Iterable&lt;T&gt;)</code> <sup>ES6</sup>
  </li>
  <li>
    <code>.add(value: T): this</code> <sup>ES6</sup>
  </li>
  <li>
    <code>.delete(value: T): boolean</code> <sup>ES6</sup>
  </li>
  <li>
    <code>.has(value: T): boolean</code> <sup>ES6</sup>
  </li>
</ul>

    
      
</body>
</html>