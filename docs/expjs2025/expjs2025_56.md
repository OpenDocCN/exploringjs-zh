# 47 日期（Date）

> 原文：[`exploringjs.com/js/book/ch_dates.html`](https://exploringjs.com/js/book/ch_dates.html)

1.  47.1 最佳实践：避免使用内置的 `Date`

    1.  47.1.1 在选择日期库时要注意的事项

1.  47.2 时间标准

    1.  47.2.1 背景：UTC 与 Z 与 GMT

    1.  47.2.2 日期不支持时区

1.  47.3 背景：日期时间格式（ISO）

    1.  47.3.1 技巧：在日期解析时附加一个 `Z` 以确保确定性

1.  47.4 时间值

    1.  47.4.1 创建时间值

    1.  47.4.2 获取和设置时间值

1.  47.5 创建日期

    1.  47.5.1 通过数字创建日期

    1.  47.5.2 从字符串中解析日期

    1.  47.5.3 创建日期的其他方法

1.  47.6 获取器和设置器

    1.  47.6.1 时间单位获取器和设置器

1.  47.7 将日期转换为字符串

    1.  47.7.1 包含时间的字符串

    1.  47.7.2 包含日期的字符串

    1.  47.7.3 包含日期和时间的字符串

    1.  47.7.4 其他方法

本章介绍了 JavaScript 用于处理日期的 API —— `Date` 类。

### 47.1 最佳实践：避免使用内置的 `Date`

JavaScript 的 `Date` API 使用起来比较繁琐。因此，对于任何与日期相关的功能，最好依赖于库。以下是一些已经实现或即将内置的功能：

+   [Temporal](https://github.com/tc39/proposal-temporal) 是一个即将推出的 ECMAScript 日期时间 API，可以通过 polyfills 使用。

+   `Intl` API 被大多数 JavaScript 平台支持，并提供了有用的日期时间相关功能：

    +   [Intl.DateTimeFormat](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/DateTimeFormat) 提供了“语言敏感的日期和时间格式化”。

    +   [Intl.RelativeTimeFormat](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/RelativeTimeFormat) 提供了“语言敏感的相对时间格式化”。

    +   [Intl.DurationFormat](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/DurationFormat) 提供了“语言敏感的持续时间格式化”。

流行库包括：

+   使用自定义日期对象的库（适用于复杂用例）：

    +   [Luxon](https://moment.github.io/luxon/)

    +   [Day.js](https://github.com/iamkun/dayjs)

    +   [js-joda](https://js-joda.github.io/js-joda/)

    +   [Moment.js](https://momentjs.com)

+   使用内置 `Date` 对象的库（适用于简单用例）：

    +   [Tempo](https://tempo.formkit.com)

    +   [date-fns](https://github.com/date-fns/date-fns)

#### 47.1.1 在选择日期库时要注意的事项

有两点需要注意：

+   *摇树干* 可以显著减少库的大小。这是一种只部署库中在某个地方导入的导出项到 Web 服务器的技术。函数比类更容易进行摇树干。

+   时区支持：如后面所述，`Date`不支持时区，这引入了许多陷阱，是其关键弱点。确保您的日期库支持它们。

### 47.2 时间标准

#### 47.2.1 背景：UTC vs. Z vs. GMT

UTC、Z 和 GMT 是表示时间的方式，它们相似但略有不同：

+   UTC（协调世界时）是所有时区都基于的时间标准。它们相对于它进行指定。也就是说，没有国家或地区将 UTC 作为其本地时区。如果一个时区有夏令时，其相对于 UTC 的偏移量在一年中会发生变化。

+   Z（非洲时间区）是一个军事时间区，常在航空和军事中作为 UTC+0 的另一个名称使用。

+   GMT（格林威治标准时间）是某些欧洲和非洲国家使用的时间区。它是 UTC 加零小时，因此与 UTC 时间相同。

来源：

+   [“GMT 和 UTC 的区别”](https://www.timeanddate.com/time/gmt-utc-time.html) 在 TimeAndDate.com

+   [“Z – 非洲时间区（军事时间）”](https://www.timeanddate.com/time/zones/z) 在 TimeAndDate.com

#### 47.2.2 日期不支持时区

日期支持以下时间标准：

+   本地时区（取决于当前位置）

+   UTC

+   时间偏移（相对于 UTC）

根据操作，只有一些选项可用。例如，当将日期转换为字符串或提取时间单位（如月份的日期）时，我们只能在本地时区和 UTC 之间选择。

内部，日期以 UTC 存储。在转换到或从本地时区时，通过日期确定必要的偏移量。以下示例中，本地时区为欧洲/巴黎：

```js
// CEST (Central European Summer Time)
assert.equal(
  new Date('2122-06-29').getTimezoneOffset(), -120);

// CET (Central European Time)
assert.equal(
  new Date('2122-12-29').getTimezoneOffset(), -60);

```

每当我们创建或转换日期时，都需要注意所使用的时间标准——例如：`new Date()`使用本地时区，而`.toISOString()`使用 UTC。

```js
> new Date(2077, 0, 27).toISOString()
'2077-01-26T23:00:00.000Z'

```

日期将 0 解释为 1 月。在本地时区中，月份的日期是 27 日，但在 UTC 中是 26 日。

![图标“提示”](img/8440b17bb8219cda9f9405ac83c36db0.png) **记录每个操作支持的时间标准**

在本章的剩余部分，每个操作都注明了支持的时间标准。

##### 47.2.2.1 无法指定时区的不利影响

无法指定时区有两个不利影响：

+   它使得支持多个时区变得不可能。

+   这可能导致特定位置的 bug。例如，前面的示例根据执行位置产生不同的结果。为了安全起见：

    +   尽可能使用基于 UTC 的操作

    +   解析字符串时使用`Z`或时差（有关更多信息，请参阅下一节）。

### 47.3 背景：日期时间格式（ISO）

日期时间格式描述：

+   以下字符串被接受：

    +   `Date.parse()`

    +   `new Date()`

+   由以下返回的字符串（总是最长格式）：

    +   `Date.prototype.toISOString()`

以下是一个由`.toISOString()`返回的日期时间字符串的示例：

```js
'2033-05-28T15:59:59.123Z'

```

日期时间格式有以下结构：

+   日期格式：Y=年；M=月；D=日

    ```js
    YYYY-MM-DD
    YYYY-MM
    YYYY

    ```

+   时间格式：T=分隔符（字符串`'T'`）；H=小时；m=分钟；s=秒和毫秒；Z=Zulu 时区（字符串`'Z'`）

    ```js
    THH:mm:ss.sss
    THH:mm:ss.sssZ

    THH:mm:ss
    THH:mm:ssZ

    THH:mm
    THH:mmZ

    ```

+   日期时间格式：是日期格式后跟时间格式。

    +   例如（最长）：`YYYY-MM-DDTHH:mm:ss.sssZ`

除了`Z`（即 UTC+0）之外，我们还可以指定相对于 UTC 的*时差*：

+   `THH:mm+HH:mm`（等等）

+   `THH:mm-HH:mm`（等等）

#### 47.3.1 小贴士：在日期解析中添加`Z`以使其确定性

如果我们在字符串末尾添加`Z`，日期解析在不同位置不会产生不同的结果。这就是我们在巴黎编写代码时会发生的情况：

+   不带`Z`：输入是 1 月 27 日（隐含在欧洲/巴黎时区），输出是 1 月 26 日（UTC）。

    ```js
    > new Date('2077-01-27T00:00').toISOString()
    '2077-01-26T23:00:00.000Z'

    ```

+   带有`Z`：输入是 1 月 27 日，输出也是 1 月 27 日。

    ```js
    > new Date('2077-01-27T00:00Z').toISOString()
    '2077-01-27T00:00:00.000Z'

    ```

### 47.4 时间值

*时间值*通过自 1970 年 1 月 1 日 00:00:00 UTC 以来的毫秒数表示日期。

时间值可以用来创建日期：

```js
const timeValue = 0;
assert.equal(
  new Date(timeValue).toISOString(),
  '1970-01-01T00:00:00.000Z');

```

将日期强制转换为数字会返回其时间值：

```js
> Number(new Date(123))
123

```

排序运算符将它们的操作数转换为数字。因此，我们可以使用这些运算符来比较日期：

```js
assert.equal(
  new Date('1972-05-03') < new Date('2001-12-23'), true);

// Internally:
assert.equal(73699200000 < 1009065600000, true);

```

#### 47.4.1 创建时间值

以下方法创建时间值：

+   `Date.now(): number` (UTC)

    返回当前时间作为时间值。

+   `Date.parse(dateTimeStr: string): number` (本地时区，UTC，时差)

    解析`dateTimeStr`并返回对应的时间值。

+   `Date.UTC(year, month, date?, hours?, minutes?, seconds?, milliseconds?): number` (UTC)

    返回指定 UTC 日期时间的时值。

#### 47.4.2 获取和设置时间值

+   `Date.prototype.getTime(): number` (UTC)

    返回与 Date 对应的时值。

+   `Date.prototype.setTime(timeValue)` (UTC)

    将`this`设置为`timeValue`编码的日期。

### 47.5 创建日期

#### 47.5.1 通过数字创建日期

`new Date(year: number, month: number, date?: number, hours?: number, minutes?: number, seconds?: number, milliseconds?: number)` (本地时区)

两个参数有陷阱：

+   对于`month`，0 是 1 月，1 是 2 月，等等。

+   如果 0 ≤ `year` ≤ 99，则添加 1900：

    ```js
    > new Date(12, 1, 22, 19, 11).getFullYear()
    1912

    ```

    正是因为这个原因，在本章的其他地方，我们避免使用时间单位`年`，而始终使用`fullYear`。但在这种情况下，我们别无选择。

例如：

```js
> new Date(2077,0,27, 21,49).toISOString() // CET (UTC+1)
'2077-01-27T20:49:00.000Z'

```

注意，输入的小时（21）与输出的小时（20）不同。前者指的是本地时区，后者指的是 UTC。

#### 47.5.2 从字符串解析日期

`new Date(dateTimeStr: string)`（本地时区，UTC，时间偏移）

如果末尾有 `Z`，则使用 UTC：

```js
> new Date('2077-01-27T00:00Z').toISOString()
'2077-01-27T00:00:00.000Z'

```

如果末尾没有 `Z` 或时间偏移，则使用本地时区：

```js
> new Date('2077-01-27T00:00').toISOString() // CET (UTC+1)
'2077-01-26T23:00:00.000Z'

```

如果字符串只包含日期，则将其解释为 UTC：

```js
> new Date('2077-01-27').toISOString()
'2077-01-27T00:00:00.000Z'

```

#### 47.5.3 创建日期的其他方式

+   `new Date(timeValue: number)`（UTC）

    ```js
    > new Date(0).toISOString()
    '1970-01-01T00:00:00.000Z'

    ```

+   `new Date()`（UTC）

    与 `new Date(Date.now())` 相同。

### 47.6 获取器和设置器

#### 47.6.1 时间单位获取器和设置器

日期有用于时间单位的选择器和设置器 – 例如：

+   `Date.prototype.getFullYear()`

+   `Date.prototype.setFullYear(num)`

这些获取器和设置器符合以下模式：

+   本地时区：

    +   `Date.prototype.get«Unit»()`

    +   `Date.prototype.set«Unit»(num)`

+   UTC：

    +   `Date.prototype.getUTC«Unit»()`

    +   `Date.prototype.setUTC«Unit»(num)`

这些是支持的时间单位：

+   日期

    +   `FullYear`

    +   `Month`：月份（0–11）。**陷阱**：0 代表一月，等等。

    +   `Date`：月份中的天数（1–31）

    +   `Day`（仅获取器）：星期中的天数（0–6，0 代表星期日）

+   时间

    +   `Hours`：小时（0–23）

    +   `Minutes`：分钟（0–59）

    +   `Seconds`：秒（0–59）

    +   `Milliseconds`：毫秒（0–999）

还有一个不符合之前提到的模式的获取器：

+   `Date.prototype.getTimezoneOffset()`

    返回本地时区与 UTC 之间的时间差（以分钟为单位）。例如，对于欧洲/巴黎，它返回 `-120`（CEST，中欧夏令时）或 `-60`（CET，中欧时间）：

    ```js
    > new Date('2122-06-29').getTimezoneOffset()
    -120
    > new Date('2122-12-29').getTimezoneOffset()
    -60

    ```

### 47.7 将日期转换为字符串

示例日期：

```js
const d = new Date(0);

```

#### 47.7.1 包含时间的字符串

+   `Date.prototype.toTimeString()`（本地时区）

    ```js
    > d.toTimeString()
    '01:00:00 GMT+0100 (Central European Standard Time)'

    ```

#### 47.7.2 包含日期的字符串

+   `Date.prototype.toDateString()`（本地时区）

    ```js
    > d.toDateString()
    'Thu Jan 01 1970'

    ```

#### 47.7.3 包含日期和时间的字符串

+   `Date.prototype.toString()`（本地时区）

    ```js
    > d.toString()
    'Thu Jan 01 1970 01:00:00 GMT+0100 (Central European Standard Time)'

    ```

+   `Date.prototype.toUTCString()`（UTC）

    ```js
    > d.toUTCString()
    'Thu, 01 Jan 1970 00:00:00 GMT'

    ```

+   `Date.prototype.toISOString()`（UTC）

    ```js
    > d.toISOString()
    '1970-01-01T00:00:00.000Z'

    ```

#### 47.7.4 其他方法

以下三个方法实际上不是 ECMAScript 的一部分，而是[ECMAScript 国际化 API](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl)的一部分。该 API 具有许多用于格式化日期的功能（包括对时区的支持），但不用于解析。

+   `Date.prototype.toLocaleTimeString()`

+   `Date.prototype.toLocaleDateString()`

+   `Date.prototype.toLocaleString()`

![练习图标“exercise”](img/4fc2ec98bb44cc1f4de7c6a46d9dd043.png) **练习：创建日期字符串**

`exercises/dates/create_date_string_test.mjs`
